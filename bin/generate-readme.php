<?php
include_once 'lib/index.php';
include_once 'lib/progress.php';

$versions = ['1.20.1', '1.21.1'];
$targets = ['active', 'merged'];

$mods = [];
foreach($versions as $version)
{
  foreach($targets as $target)
  {
    $dir = BASEDIR . '/src/' . $version . '/' . $target;
    if (!is_dir($dir)) {
      echo "\e[031m * Directory \e[034m$dir\e[031m does not exist\e[0m" . PHP_EOL;
      continue;
    }
    
    $subdirs = array_filter(glob($dir . '/*'), 'is_dir');
    foreach ($subdirs as $subdir) {
      $modName = basename($subdir);
      if (!isset($mods[$modName]))
        $mods[$modName] = ['versions' => [], 'targets' => [], 'meta' => []];
      $mods[$modName]['folder'] = $modName;
      $mods[$modName]['versions'][$version] = ['status' => $target, 'pr' => false, 'merged' => false, 'crowdin' => false, 'progress' => 0];
      $mods[$modName]['notes'] = '';

      $upstreamDir = BASEDIR . '/src/' . $version . '/upstream/' . $modName;
      if (is_dir($upstreamDir)) {
        if (file_exists($upstreamDir . '/pr')) {
          $mods[$modName]['versions'][$version]['pr'] = true;
        }
        if (file_exists($upstreamDir . '/merged')) {
          $mods[$modName]['versions'][$version]['merged'] = true;
        }
        if (file_exists($upstreamDir . '/modrinth.json')) {
          $mods[$modName]['meta'] = json_decode(file_get_contents($upstreamDir . '/modrinth.json'), true);
        }
        $progressData = getProgress($version, $modName, $target);
        $mods[$modName]['versions'][$version]['progress'] = $progressData['percent'];

        if (file_exists($upstreamDir . '/notes')) {
          $notes = file_get_contents($upstreamDir . '/notes');
          $mods[$modName]['notes'] .= trim($notes);
        }
      }
    }
  }
}

$output = "# Hungarian translations / Magyar ford√≠t√°sok" . PHP_EOL;
$output .= PHP_EOL;
$output .= "## Status" . PHP_EOL;
$output .= PHP_EOL;
$output .= "| Mod | " . implode(' | ', $versions) . " | Notes |" . PHP_EOL;
$output .= "| --- | " . str_repeat('--- | ', count($versions)) . " --- |" . PHP_EOL;

foreach($mods as $modName => $modData) {
  $modTitle = isset($modData['meta']['title']) ? "[{$modData['meta']['title']}]({$modData['meta']['url']})" : $modName;
  $output .= "| $modTitle | ";

  foreach($versions as $version) {
    if (isset($modData['versions'][$version])) {
      $status = $modData['versions'][$version]['status'];
      if ($status == 'merged') {
        $status = '‚úÖ';
      } elseif ($status == 'active') {
        if ($modData['versions'][$version]['merged']) $status = 'üü£';
        elseif ($modData['versions'][$version]['pr']) $status = ' üîµ';
        else $status = 'üü¢';
        // @TODO: Crowdin
      } else {
        $status = '‚ùå';
      }
      if (isset($modData['versions'][$version]['progress']) && $modData['versions'][$version]['progress'] > 0) {
        $progress = (int) floatval($modData['versions'][$version]['progress']);
        $status .= " ($progress%)";
      }
      $output .= "$version $status | ";
    } else {
      $output .= "$version ‚ùå| ";
    }
  }
  
  $output .= $modData['notes'] ?? ''; 

  $output .= " | " . PHP_EOL;
}

$output .= "
# Notes

- *1: Auto/tool generated, reviewed and fixed by hand
- *2: Autogenerated from Minecraft sources
- *3: Some keys are not possible to translate
- *4: Unused?
";

echo $output . PHP_EOL;
